{% extends 'base_admin.html.twig' %}

{% block title %}Modulo de Venta{% endblock %}

{% block body %}
<style>

    .filterDiv {
    display: none; /* Hidden by default */
    }
    
    .show {
    display: block;
    }

    

    .btn.active {
  background-color: #666;
  color: white;
  }

</style>

<div class="card">
        <div class="card-header">
        <i class="fas fa-table"></i>
        Punto de Venta   
        </div>

        <div class="card-body">
     
            <div class="my-2" id="myBtnContainer">
                <button class="btn btn-primary" onclick="filterSelection('all')"> Todos</button>
                {% for category in categories %}
                    <button class="btn btn-primary" onclick="filterSelection('{{ category.name }}')">{{ category.name }}</button>
                {% endfor %}
            </div>
                
            <div id="ParentContainer" class="container-fluid">

            <div class ="row">
                <div style="width:70%;border:0px solid #333; border-radius:5px; padding: 10px;" align="center">
        
                <div class="search-button input-group">
                    <input id="product_search" class="form-control rounded my-1" type="text" placeholder="Codigo de Barras">
                    <button id="search_product" onclick="" class="mx-1 search_product btn btn-primary">Agregar</button>
                </div>

                <div class="search-button-sku input-group">
                    <input id="product_search_input_sku" class="form-control rounded my-1" type="text" placeholder="SKU" onkeyup="showResultSKU(this.value)">
                    <button id="search_product_btn_sku" onclick="searchSKU()" class="mx-1 search_product_btn btn btn-primary">Agregar</button>
                </div>
                <div class="" id="livesearch_sku" style="z-index:1;position:absolute; border-radius: 5px; background: white none repeat scroll 0% 0%; width: 50%;"></div>

                <div class="search-button-name input-group">
                    <input id="product_search_input_name" class="form-control rounded my-1" type="text" placeholder="Nombre" onkeyup="showResultName(this.value)">
                    <button id="search_product_btn_name" onclick="searchName()" class="mx-1 search_product_name_btn btn btn-primary">Agregar</button>
                </div>
                <div class="" id="livesearch_name" style="z-index:1;position:absolute; border-radius: 5px; background: white none repeat scroll 0% 0%; width: 50%;"></div>



                <div id="catalog" class = "row">
                    
                    {% for product in products %}

                     {%  if product.category != null %}
                        <div class="col-lg-3 col-md-6 filterDiv {{ product.category.name }}" style="max-height: 500px">
                            {% else %}
                            <div class="col-lg-3 col-md-6 filterDiv General">
                                {% endif %}

                                <div class="card ">
                                    <div class="card-body">
                                    {%  if product.image != null %}
                                        <img class="card-img-top img-fluid product_drag " style="height:150px;  width:100%;" src="{{ '/uploads/' ~ product.image }}" data-id="{{ product.id }}" data-upc="{{ product.upc }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-taxable="{{ product.isTaxable }}"  alt="image"/>
                                    {% else %}
                                        <img class="card-img-top img-fluid product_drag " style="height:150px;  width:100%;" src="{{ asset('assets/images/product_placeholder.jpg') }}" data-id="{{ product.id }}" data-upc="{{ product.upc }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-taxable="{{ product.isTaxable }}" alt="image"/>
                                    {% endif %}
                                        <h4 class="card-title">{{ product.name }}</h4>
                                       {%  if product.quantity is not null %}
                                        <h6 class="text-muted">Existencia: <p class="my-0"id="product-quantity">{{ product.quantity }}</p></h6>
                                    {% else %}
                                        <h6 class="text-muted">Existencia Ilimitada <p class="my-0"id="product-quantity">999</p></h6>
                                    {% endif %}


                                    {%  if product.price is not null %}
                                        <h4 class="text-danger">${{ product.price }}</h4>
                                    {% else %}
                                    <div class="add-button input-group">
                                        <h5 class="text-danger my-1 mx-1">Precio:</h5><input id="product_price" class=" form-control container-fluid rounded my-0" type="number" placeholder="0">
                                    </div>
                                        {% endif %}

                                    <div class="add-button input-group">
                                        {%  if product.price is not null %}

                                            <button id="add_product" class="mx-1 add_product btn btn-sm btn-primary">Agregar</button>
                                            <input id="product_amount" class="form-control rounded my-1" type="number" pattern="[0-9]" value="1">

                                        {% else %}

                                            <button id="add_service" class="mx-auto add_service btn btn-primary my-2">Agregar</button>

                                        {% endif %}

                                    </div>

                                    </div>
                                </div>
                            </div>

                    {% endfor %}

                </div>
            </div>
            
            <div id="FixedDiv" class="mx-1 card position-fixed" style=" width:29%;height:85%;border:0px solid #333; background-color:#ffffff; border-radius:5px; padding-left: 10px; padding-right: 10px; top:100px; right:15px" align="center">
                <h3>Carrito</h3>
                
                <div id="dragable_product_order">
                
                </div>
                
                    <table id="cart" class="cart-table table table-bordered table-striped table-sm" style="overflow-y:scroll;height:330px;display:block;" >
                        <p class="mb-0">Cliente</p>
                        
                        <div class="row">
                            <div class="col-sm-3 pr-0">
                                <div class="form-group">
                                    <input type="text" id="client_code" class="form-control " placeholder="Codigo" onkeyup="showResultCode(this.value)">
                                </div>
                            </div>
                            <div class="col-sm-9 pl-0">
                                <div class="form-group">
                                    <input type="text" id="client_name" class="form-control" placeholder="Nombre" onkeyup="showResultClient(this.value)">
                                </div>
                            </div>
                        </div>
                        <div class="" id="livesearch_client" style="  border-radius: 5px; position: absolute; top: 95px; background: white none repeat scroll 0% 0%; width: 95%;"></div>

                        <thead>
                        <tr>
                            <th style="width:10%">Nombre</th>
                            <th style="width:10%">Cantidad</th>
                            <th style="width:10%">Precio</th>
                            <th style="width:10%"></th>
                        </tr>
                        </thead>
                        <tbody>

                            <tr>
                                <td>Subtotal:</td>
                                <td id="subtotal">0.00</td>
                            </tr>

                            <tr>
                                <td>IVA:</td>
                                <td id="tax">0.00</td>
                            </tr>
                            <tr>
                                <td>Total:</td>
                                <td id="total">0.00</td>
                            </tr>
                            

                        </tbody>

                    </table>

                <div class="table-responsive-lg">

                <table id="cart-discount" class="cart-discount table table-bordered table-striped table-sm" style="overflow-y:scroll;height:130px;display:block;"  >
                    <thead>
                    <tr>
                        <th style="width:10%">Producto</th>
                        <th style="width:10%">Razon</th>
                        <th style="width:10%">Descuento</th>
                        <th style="width:10%"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                

                    </tr>
                   


                    </tbody>
                </table>
  </div>
                <button type='submit' onclick="payment(this)" class='payment-button btn btn-primary my-2 '>Pagar</button>

            </div>

            </div>
           
    </div>
</div>

<!-- sample modal content -->
<div id="myModal" class="modal fade" tabindex="-1" role="dialog"
    aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Descuentos</h4>
                <button type="button" class="close" data-dismiss="modal"
                    aria-hidden="true">Ã—</button>
            </div>
            <div class="modal-body" data-id='-1'>
                <div class="table-responsive-lg">

            <table class="table table-bordered table-striped order_table" id="zero_config" >
                    <thead>
                    
                    <tr>
                        <th style="width:10%" >Nombre descuento</th>
                        <th style="width:10%" >Tipo de Descuento</th>
                        <th style="width:10%" >Valor</th>
                        <th style="width:10%" >Acciones</th>

                    </tr>
                    </thead>
                    <tbody>

                    {% for discount in discounts %}
                     <tr>
                <td data-id="{{ discount.id }}" data-name="{{ discount.name }}" data-amount="{{ discount.amount }}" data-type="{{ discount.type }}">{{ discount.name }}</td>
                {% if discount.type == 0 %}
                <td>Monto</td>

                {% else %}
                <td>Porcentaje</td>

                {% endif %}

                {% if discount.type == 0 %}
                <td>${{ discount.amount }}</td>

                {% else %}
                <td>{{ discount.amount }}%</td>

                {% endif %}

                <td>
                    <button class="add_discount_1 btn btn-success" >Agregar</button>
                </td>
            </tr>
                    {% endfor %}
                    
                    </tbody>
                    
                </table>
</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light"
                    data-dismiss="modal">Cerrar</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

    <script src="{{ asset('theme/assets/libs/jquery/dist/jquery.min.js') }}"></script>
    <script type="javascript" src="{{ asset('theme/assets/libs/bootstrap/dist/js/bootstrap.min.js') }}"></script>
    


    <script>
        var input = document.getElementById("product_search");
        input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                search(input.value);
                input.value = '';

            }
        });
    </script>

    <script type="text/javascript">
        function selectClient(str){
            
            if(str.includes(':')){
            var code = str.split(':')[1];
            document.getElementById("client_code").value=code;
            document.getElementById("client_name").value=str.split(':')[0];
            }else{
            document.getElementById("client_name").value=str;
            }
        

            document.getElementById("livesearch_client").innerHTML="";
            document.getElementById("livesearch_client").style.border="0px";
        }

        function CreateNewClient(){
          
            var str = document.getElementById("client_name").value;
            var code = document.getElementById("client_code").value;
            //add code to client
            $.ajax({
                    url:"{{ path('create_client') }}",
                    type: "POST",
                    dataType:"text",
                    data:{
                        name:str,
                        code:code
                    },
                    success:function (php_result) {
                        document.getElementById("livesearch_client").innerHTML="";
                        document.getElementById("livesearch_client").style.border="0px";
                    }
                });
                
        
        }

        function showResultClient(str) {
             if (str.length==0) {
                document.getElementById("livesearch_client").innerHTML="";
                document.getElementById("livesearch_client").style.border="0px";
                return;
            }
            $.ajax({
                    url:"{{ path('fetch_clients') }}",
                    type: "POST",
                    dataType:"text",
                    data:{
                        name:str
                    },
                    success:function (php_result) {
                        if(php_result !== '[]') {
                            var clients = JSON.parse(php_result);
                            var searchResults = ""
                            for(var i =0; i < clients.length;i++){
                                var name = clients[i].name
                               // console.log(name+" " + clients[i].code);
                               if(clients[i].code !== null){
                                searchResults += '<a class="text-primary" onclick="selectClient(this.innerHTML)">'+clients[i].name+':'+clients[i].code+'</a><br/>'
                               }else{
                                searchResults += '<a class="text-primary" onclick="selectClient(this.innerHTML)">'+clients[i].name+'</a><br/>'
                               }
                            }
                            document.getElementById("livesearch_client").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_client").innerHTML = searchResults;
                        }
                        else{
                            document.getElementById("livesearch_client").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_client").innerHTML = '<a class="text-success" onclick="CreateNewClient()">Crear Cliente</a><br/>';
                        }       
                    }
                });
            }

            function showResultCode(str) {
             if (str.length==0) {
                document.getElementById("livesearch_client").innerHTML="";
                document.getElementById("livesearch_client").style.border="0px";
                return;
            }
            $.ajax({
                    url:"{{ path('fetch_clients_code') }}",
                    type: "POST",
                    dataType:"text",
                    data:{
                        code:str
                    },
                    success:function (php_result) {
                        if(php_result !== '[]') {
                            var clients = JSON.parse(php_result);
                            var searchResults = ""
                            for(var i =0; i < clients.length;i++){
                                var name = clients[i].name
                                console.log(name);
                               if(clients[i].code !== null){
                                searchResults += '<a class="text-primary" onclick="selectClient(this.innerHTML)">'+clients[i].name+':'+clients[i].code+'</a><br/>'
                               }else{
                                searchResults += '<a class="text-primary" onclick="selectClient(this.innerHTML)">'+clients[i].name+'</a><br/>'
                               }                            }
                            document.getElementById("livesearch_client").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_client").innerHTML = searchResults;
                        }
                        else{
                            if(document.getElementById("client_name").value !== ''){
                            document.getElementById("livesearch_client").style.border="1px solid #A5ACB2";
                            document.getElementById("livesearch_client").innerHTML = '<a class="text-success" onclick="CreateNewClient()">Crear Cliente</a><br/>';

                            }
                        }       
                    }
                });
            }
        

    </script>

    <script type="text/javascript">
        function selectProductName(str){
            document.getElementById("product_search_input_name").value=str;
            document.getElementById("livesearch_name").innerHTML="";
            document.getElementById("livesearch_name").style.border="0px";
        }

        function clearProductName(){
            document.getElementById("product_search_input_name").value='';
            document.getElementById("livesearch_name").innerHTML="";
            document.getElementById("livesearch_name").style.border="0px";
        }

        function showResultName(str) {
             if (str.length==0) {
                document.getElementById("livesearch_name").innerHTML="";
                document.getElementById("livesearch_name").style.border="0px";
                return;
            }
            $.ajax({
                    url:"{{ path('fetch_products_name') }}",
                    type: "POST",
                    dataType:"text",
                    data:{
                        name:str
                    },
                    success:function (php_result) {
                        if(php_result !== '[]') {
                            var products = JSON.parse(php_result);
                            var searchResults = ""
                            for(var i =0; i < products.length;i++){
                                var name = products[i].name
                                console.log(name);
                                searchResults += '<a class="text-primary" onclick="selectProductName(this.innerHTML)">'+products[i].name+'</a><br/>'
                            }
                            document.getElementById("livesearch_name").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_name").innerHTML = searchResults;
                        }
                        else{
                            document.getElementById("livesearch_name").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_name").innerHTML = '<a class="text-success" onclick="clearProductName()">Sin Resultados</a><br/>';
                        }       
                    }
                });
            }
        

    </script>

    <script type="text/javascript">
        function selectProduct(str){
            var sku = str.split(': ')[1];
            document.getElementById("product_search_input_sku").value=sku;
            document.getElementById("livesearch_sku").innerHTML="";
            document.getElementById("livesearch_sku").style.border="0px";
        }

        function clearProduct(){
            document.getElementById("product_search_input_sku").value='';
            document.getElementById("livesearch_sku").innerHTML="";
            document.getElementById("livesearch_sku").style.border="0px";
        }

        function CreateClient(){
          
            var str = document.getElementById("product_search_input_sku").value;
           
                
        
        }



        function showResultSKU(str) {
             if (str.length==0) {
                document.getElementById("livesearch_sku").innerHTML="";
                document.getElementById("livesearch_sku").style.border="0px";
                return;
            }
            $.ajax({
                    url:"{{ path('fetch_products_sku') }}",
                    type: "POST",
                    dataType:"text",
                    data:{
                        sku:str
                    },
                    success:function (php_result) {
                        if(php_result !== '[]') {
                            var products = JSON.parse(php_result);
                            var searchResults = ""
                            for(var i =0; i < products.length;i++){
                                var name = products[i].name
                                console.log(name);
                                searchResults += '<a class="text-primary" onclick="selectProduct(this.innerHTML)">'+products[i].name+' : '+products[i].sku+'</a><br/>'
                            }
                            document.getElementById("livesearch_sku").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_sku").innerHTML = searchResults;
                        }
                        else{
                            document.getElementById("livesearch_sku").style.border="1px solid #A5ACB2"
                            document.getElementById("livesearch_sku").innerHTML = '<a class="text-success" onclick="clearProduct()">Sin Resultados</a><br/>';
                        }       
                    }
                });
            }
        

    </script>

    <script type="text/javascript">

        filterSelection("all");
        
        function filterSelection(c) {
            var x, i;
            x = document.getElementsByClassName("filterDiv");
            if (c === "all") c = "";
            // Add the "show" class (display:block) to the filtered elements, and remove the "show" class from the elements that are not selected
            for (i = 0; i < x.length; i++) {
                w3RemoveClass(x[i], "show");
                if (x[i].className.indexOf(c) > -1) w3AddClass(x[i], "show");
            }
        }

        // Show filtered elements
        function w3AddClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                if (arr1.indexOf(arr2[i]) == -1) {
                    element.className += " " + arr2[i];
                }
            }
        }

        // Hide elements that are not selected
        function w3RemoveClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                while (arr1.indexOf(arr2[i]) > -1) {
                    arr1.splice(arr1.indexOf(arr2[i]), 1);
                }
            }
            element.className = arr1.join(" ");
        }

        // Add active class to the current control button (highlight it)
        var btnContainer = document.getElementById("myBtnContainer");
        var btns = btnContainer.getElementsByClassName("btn");
        for (var i = 0; i < btns.length; i++) {
            btns[i].addEventListener("click", function() {
                var current = document.getElementsByClassName("active");
                current[0].className = current[0].className.replace(" active", "");
                this.className += " active";
            });
        }

    </script>



    <script type="text/javascript">

        //$(window).on('load', function() {
           // $('#myModal').modal('handleUpdate');
        //});
        /*
        $(document).ready(function(data){

            console.log("HI");

            $.ajax({
                url:"{{ path('fetch_products') }}",
                type: "POST",
                dataType: "text",
                data:{
                    start:0,
                    length:10
                },
                success:function (php_result) {
                    if(php_result !== '[]') {

                        console.log(php_result);

                    }else{
                        console.log("No results");

                    }
                }
            });


        });

       */


        $('#myModal').on('hide.bs.modal', function (e) {
         //   $('#myModal').modal('handleUpdate');
            $("#clients-table > tbody").empty();

        });

        $(document).ready(function(data){

            $('.product_drag_area').on('dragover', function(){
                $(this).addClass('product_drag_over');
                return false;
            });
            $('.product_drag_area').on('dragleave', function(){
                $(this).removeClass('product_drag_over');
                return false;
            });
            $('.product_drag').on('dragstart', function(e){
                e.originalEvent.dataTransfer.setData("id", $(this).data("id"));
                e.originalEvent.dataTransfer.setData("name", $(this).data("name"));
                e.originalEvent.dataTransfer.setData("price", $(this).data("price"));
            });
            $('.product_drag_area').on('drop', function(e){
                e.preventDefault();
                $(this).removeClass('product_drag_over');
                var id = e.originalEvent.dataTransfer.getData('id');
                var name = e.originalEvent.dataTransfer.getData('name');
                var price = e.originalEvent.dataTransfer.getData('price');
                var action = "add";
                $.ajax({
                    url:"action.php",
                    method:"POST",
                    data:{id:id, name:name, price:price, action:action},
                    success:function(data){
                        $('#dragable_product_order').html(data);
                    }
                })
            });

            $('#ParentContainer').scroll(function() {
                $('#FixedDiv').css('top', $(this).scrollTop());
            });

            $(document).on('click', '.remove_discount', function(){
            var prodID = $(this).parent().parent().attr('id');
            var discount = parseFloat($(this).parent().parent().children()[2].innerText);
            var prodTaxable = $("img[data-id='" + prodID +"']").attr('data-taxable');
            var prodName = $("img[data-id='" + prodID +"']").attr('data-name');

            var total = document.querySelector('#total');
            var subtotal = document.querySelector('#subtotal');
            var tax = document.querySelector('#tax');

            var cellVal = $(".cart-table tr td").filter(function() {
                return $(this).text() === prodName;
            });

            if(cellVal.text() !== ""){
               var price = parseFloat(cellVal.parent().children()[2].innerText);
               cellVal.parent().children()[2].innerText = (price + discount);

            }
         
                if(prodTaxable ==="1"){
                    var taxPerProduct = parseFloat(((discount)/1.16) * 0.16).toFixed(3);
                    tax.innerText = (parseFloat(tax.innerText) + parseFloat(taxPerProduct)).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) + discount).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + parseFloat(discount - taxPerProduct)).toFixed(3);
                }else{
                    total.innerText = (parseFloat(total.innerText) + (discount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (discount)).toFixed(3);
                }

            $(this).parent().parent().remove();

            });

            $(document).on('click', '.remove_all', function(){
                var quantity = $(this).parent().parent().parent().parent().children()[1].innerText;
                var prodPrice = parseFloat($(this).parent().parent().parent().parent().children()[2].innerText)/parseFloat(quantity);
                var prodID = $(this).parent().parent().parent().parent().attr('id');
                var productCard = $("img[data-id='" + prodID +"']").parent().children('h6').children('p');
                var prodTaxable = $("img[data-id='" + prodID +"']").attr('data-taxable');

                var total = document.querySelector('#total');
                var subtotal = document.querySelector('#subtotal');
                var tax = document.querySelector('#tax');

                var i = $(this).parent().parent().parent().parent().index();
                var table = $(this).parent().parent().parent().parent().parent();

                    if(productCard[0] !== undefined){
                        productCard[0].innerText = parseFloat(productCard[0].innerText) + parseInt(quantity);
                    }

                if(prodTaxable ==="1"){
                    var taxPerProduct = (prodPrice/1.16) * 0.16;

                    var taxAmt = parseFloat(taxPerProduct).toFixed(3) * parseInt(quantity);
                    tax.innerText = (parseFloat(tax.innerText) - (taxAmt)).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) - (prodPrice * parseInt(quantity))).toFixed(3);
                    var subtotalTax = ((prodPrice * parseInt(quantity)) - (taxAmt)).toFixed(3)
                    subtotal.innerText = (parseFloat(subtotal.innerText) - parseFloat(subtotalTax)).toFixed(3);
                }else{
                    total.innerText = (parseFloat(total.innerText) - (prodPrice * parseInt(quantity))).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) - (prodPrice * parseInt(quantity))).toFixed(3);

                }

                $(this).parent().parent().parent().parent().remove();

            });

            $(document).on('click', '.remove_product', function(){
                var quantity = $(this).parent().parent().parent().parent().children()[1].innerText;
                var prodPrice = parseFloat($(this).parent().parent().parent().parent().children()[2].innerText)/parseFloat(quantity);
                var prodID = $(this).parent().parent().parent().parent().attr('id');
                var productCard = $("img[data-id='" + prodID +"']").parent().children('h6').children('p');
                var prodTaxable = $("img[data-id='" + prodID +"']").attr('data-taxable');

                var total = document.querySelector('#total');
                var subtotal = document.querySelector('#subtotal');
                var tax = document.querySelector('#tax');

                var i = $(this).parent().parent().parent().parent().index();
                var table = $(this).parent().parent().parent().parent().parent();

                if(quantity === "1"){
                    $(this).parent().parent().parent().parent().remove();

                    if(productCard[0] !== undefined){
                        productCard[0].innerText = parseFloat(productCard[0].innerText) + 1;
                    }

                }else{
                    $(this).parent().parent().parent().parent().children()[1].innerText = quantity - 1;

                    if(productCard[0] !== undefined){
                        productCard[0].innerText = parseFloat(productCard[0].innerText) + 1;
                    }
                    var price = parseFloat($(this).parent().parent().parent().parent().children()[2].innerText);
                    $(this).parent().parent().parent().parent().children()[2].innerText = price - prodPrice;

                }



                if(prodTaxable ==="1"){
                    var taxAmt = ((prodPrice) - (prodPrice/1.16)).toFixed(3);
                    tax.innerText = (parseFloat(tax.innerText) - (taxAmt)).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) - prodPrice).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) - (prodPrice - taxAmt).toFixed(3) ).toFixed(3);
                }else{
                    total.innerText = (parseFloat(total.innerText) - prodPrice).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) - prodPrice).toFixed(3);

                }


            });

            $(document).on('click', '.add_product', function(){
                var prodAmount = parseInt($(this).parent().parent().find("#product_amount").val());

                var cart = $('.cart-table');
                var imgtodrag = $(this).parent().parent().children('img').eq(0);
                console.log(imgtodrag);
                if (imgtodrag) {
                    var imgclone = imgtodrag.clone()
                        .offset({
                            top: imgtodrag.offset().top,
                            left: imgtodrag.offset().left
                        })
                        .css({

                            'position': 'absolute',
                            'height': '150px',
                            'width': '150px',
                            'z-index': '100'
                        })
                        .appendTo($('body'))
                        .animate({
                            'top': cart.offset().top + 50,
                            'left': cart.offset().left + 150,
                            'width': 75,
                            'height': 75
                        }, 500, 'easeInOutExpo');



                    imgclone.animate({
                        'width': 0,
                        'height': 0
                    }, function () {
                        $(this).detach()
                    });
                }

                var prodName = $(this).parent().parent().children('img').attr('data-name');
                var prodPrice = parseFloat($(this).parent().parent().children('img').attr('data-price'));
                var prodID = $(this).parent().parent().children('img').attr('data-id');
                var prodTaxable = $(this).parent().parent().children('img').attr('data-taxable');

                var prod_quantity = $(this).parent().parent().find("#product-quantity");
                if(prod_quantity[0] !== undefined){
                    prod_quantity[0].innerText = parseInt(prod_quantity[0].innerText) - prodAmount;
                }

                var total = document.querySelector('#total');
                var subtotal = document.querySelector('#subtotal');
                var tax = document.querySelector('#tax');


                var cellVal = $(".cart-table tr td").filter(function() {
                    return $(this).text() === prodName;
                });
                if(cellVal.text() === ""){
                    if(prodAmount ===1){
                        $(".cart-table").prepend('<tr id="'+prodID+'"><td >'+prodName+'</td><td id="quantity">1</td><td id="price">'+prodPrice+'</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                    }else{

                        $(".cart-table").prepend('<tr id="'+prodID+'"><td >'+prodName+'</td><td id="quantity">'+ prodAmount +'</td><td id="price">'+(prodPrice * prodAmount)+'</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                    }

                }else{
                    var quantity = parseInt(cellVal.parent().children()[1].innerText);
                    cellVal.parent().children()[1].innerText = quantity + prodAmount;

                    var price = parseFloat(cellVal.parent().children()[2].innerText);
                    cellVal.parent().children()[2].innerText = price + (prodPrice * prodAmount);
                }

                if(prodTaxable ==="1"){
                    var taxPerProduct = (prodPrice/1.16) * 0.16;
                    var taxAmt = (taxPerProduct.toFixed(3) * prodAmount);
                    var taxDisplay = parseFloat(tax.innerText) + parseFloat(taxAmt);
                    tax.innerText = parseFloat(taxDisplay).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount) - taxAmt ).toFixed(3);

                }else{
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount)).toFixed(3);
                }

            });


            $(document).on('click', '.add_service', function(){
                var prodPrice = parseFloat($(this).parent().parent().children().children('input').val());

                if(!isNaN(prodPrice)){
                    var cart = $('.cart-table');
                    var imgtodrag = $(this).parent().parent().children('img').eq(0);
                    if (imgtodrag) {
                        var imgclone = imgtodrag.clone()
                            .offset({
                                top: imgtodrag.offset().top,
                                left: imgtodrag.offset().left
                            })
                            .css({

                                'position': 'absolute',
                                'height': '150px',
                                'width': '150px',
                                'z-index': '100'
                            })
                            .appendTo($('body'))
                            .animate({
                                'top': cart.offset().top + 50,
                                'left': cart.offset().left + 150,
                                'width': 75,
                                'height': 75
                            }, 500, 'easeInOutExpo');



                        imgclone.animate({
                            'width': 0,
                            'height': 0
                        }, function () {
                            $(this).detach()
                        });
                    }

                    var prodName = $(this).parent().parent().children('img').attr('data-name');

                    var prod_quantity = $(this).parent().parent().find("#product-quantity");

                    var prodID = $(this).parent().parent().children('img').attr('data-id');
                    var prodTaxable = $(this).parent().parent().children('img').attr('data-taxable');

                    if(prod_quantity[0] !== undefined){
                        prod_quantity[0].innerText = parseInt(prod_quantity[0].innerText)-1;
                    }


                    var total = document.querySelector('#total');
                    var subtotal = document.querySelector('#subtotal');
                    var tax = document.querySelector('#tax');


                    var cellName = $(".cart-table tr td").filter(function() {
                        return $(this).text() === prodName;
                    });

                    var cellPrice = $(".cart-table tr td").filter(function() {
                        return $(this).text() === prodPrice;
                    });

                    if(cellName.text() === ""){
                        $(".cart-table").prepend('<tr id="'+prodID+'"><td >'+prodName+'</td><td id="quantity">1</td><td id="price">'+prodPrice+'</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product dropdown-item text-success" type="button">Descuentos</button></div></div></td></tr>');
                    }else{
                        $(".cart-table").prepend('<tr id="'+prodID+'"><td >'+prodName+'</td><td id="quantity">1</td><td id="price">'+prodPrice+'</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product dropdown-item text-success" type="button">Descuentos</button></div></div></td></tr>');
                    }


                    if(prodTaxable ==="1"){
                        var taxAmt = ((prodPrice) - (prodPrice/1.16)).toFixed(3);
                        var taxDisplay = parseFloat(tax.innerText) + parseFloat(taxAmt);
                        tax.innerText = (parseFloat(taxDisplay)).toFixed(3);
                        total.innerText = (parseFloat(total.innerText) + prodPrice).toFixed(3);
                        subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice - taxAmt) ).toFixed(3);

                    }else{
                        total.innerText = (parseFloat(total.innerText) + prodPrice).toFixed(3);
                        subtotal.innerText = (parseFloat(subtotal.innerText) + prodPrice).toFixed(3);

                    }
                }

            });

        });


            $(document).on('click', '.discount_product_1', function(){
                console.log('clicked');
                var modal = $('.modal-body');
                var prodID = $(this).parent().parent().parent().parent().attr('id');
                $('.modal-body').attr('data-id',prodID);
               

            });

            $(document).on('click', '.add_discount_1', function(){
                var prodID = $('.modal-body').attr('data-id');
               
                var cart = $('.cart-table');
                var row = '';

                $('.cart-table tr').each(function() {
                    if(this.id === prodID){
                        row = this;
                    }
                })
                var price = parseFloat(row.children[2].innerText);
                var prodTaxable = $("img[data-id='" + prodID +"']").attr('data-taxable');
                var total = document.querySelector('#total');
                var subtotal = document.querySelector('#subtotal');
                var tax = document.querySelector('#tax');
                var prodName = $("img[data-id='" + prodID +"']").attr('data-name');

                var discount_cart = $('.cart-discount');
                var discountId = $(this).parent().parent().children()[0].attributes[0].value;
                var reason = $(this).parent().parent().children()[0].attributes[1].value;
                var discount = parseFloat($(this).parent().parent().children()[0].attributes[2].value);
                var type = parseInt($(this).parent().parent().children()[0].attributes[3].value);

                if(type === 0){
                    if (discount < price){
                        $('.cart-discount > tbody:last-child').append('<tr id="'+prodID+'"><td>'+prodName+'</td><td id="'+discountId+'" class="discount_reason">'+ reason +'</td><td id="price">'+ discount +'</td><td><div class="remove_discount btn btn-warning my-1 btn-sm">Borrar</div></td></tr>');
                        row.children[2].innerText = parseFloat(price - discount).toFixed(2);

                        if(prodTaxable ==="1"){
                            var taxPerProduct = parseFloat(((price-discount)/1.16) * 0.16).toFixed(3);
                            tax.innerText = (parseFloat(tax.innerText) - (parseFloat(tax.innerText) - taxPerProduct)).toFixed(3);
                            total.innerText = (parseFloat(total.innerText) - discount).toFixed(3);
                            subtotal.innerText = (parseFloat(subtotal.innerText) - (discount/1.16)).toFixed(3);
                        }else{
                            total.innerText = (parseFloat(total.innerText) - (discount)).toFixed(3);
                            subtotal.innerText = (parseFloat(subtotal.innerText) - (discount)).toFixed(3);
                        }

                    }

                }else{
                    if(discount === 33){
                        discount = 33.3333333333;
                    }
                    if(discount === 66){
                        discount = 66.6666666666;
                    }
                        discount = price*(discount/100);
                        console.log(discount);
                        $('.cart-discount > tbody:last-child').append('<tr id="'+prodID+'"><td>'+prodName+'</td><td id="'+discountId+'" clas="discount_reason">'+ reason +'</td><td id="price">'+ discount.toFixed(2) +'</td><td><div class="remove_discount btn btn-warning my-1 btn-sm">Borrar</div></td></tr>');
                        row.children[2].innerText = parseFloat(price - discount).toFixed(2);

                        if(prodTaxable ==="1"){
                            var taxPerProduct = parseFloat(((price-discount)/1.16) * 0.16).toFixed(3);
                            tax.innerText = (parseFloat(tax.innerText) - (parseFloat(tax.innerText) - taxPerProduct)).toFixed(3);
                            total.innerText = (parseFloat(total.innerText) - discount).toFixed(3);
                            subtotal.innerText = (parseFloat(subtotal.innerText) - (discount/1.16)).toFixed(3);
                        }else{
                            total.innerText = (parseFloat(total.innerText) - (discount)).toFixed(3);
                            subtotal.innerText = (parseFloat(subtotal.innerText) - (discount)).toFixed(3);
                        }

                }
                
                
                

            });

            $(document).on('click', '.discount_product', function(){
                var reason = prompt("Ingresar razon de descuento","Descuento");
                var discount = parseFloat(prompt("Ingresar monto por descontar",""));

                var price = parseFloat($(this).parent().parent().parent().parent().children()[2].innerText);
                var prodID = $(this).parent().parent().parent().parent().attr('id');
                var prodTaxable = $("img[data-id='" + prodID +"']").attr('data-taxable');
                var total = document.querySelector('#total');
                var subtotal = document.querySelector('#subtotal');
                var tax = document.querySelector('#tax');
                var prodName = $("img[data-id='" + prodID +"']").attr('data-name');

                var discount_cart = $('.cart-discount');

                if (discount!=null && $.isNumeric(discount) && discount < price){
                    $('.cart-discount > tbody:last-child').append('<tr id="'+prodID+'"><td>'+prodName+'</td><td id="discount_reason">'+ reason +'</td><td id="price">'+ discount +'</td><td><div class="remove_discount btn btn-warning my-1 btn-sm">Borrar</div></td></tr>');
                    $(this).parent().parent().parent().parent().children()[2].innerText = price - discount;

                    if(prodTaxable ==="1"){
                        var taxPerProduct = parseFloat(((price-discount)/1.16) * 0.16).toFixed(3);
                        //tax.innerText = (parseFloat(tax.innerText) - ((((price)*.16) - (price - discount)*.16))).toFixed(3);
                        tax.innerText = (parseFloat(tax.innerText) - (parseFloat(tax.innerText) - taxPerProduct)).toFixed(3) ;

                        total.innerText = (parseFloat(total.innerText) - discount).toFixed(3);
                        subtotal.innerText = (parseFloat(subtotal.innerText) - (discount/1.16)).toFixed(3);
                    }else{
                        total.innerText = (parseFloat(total.innerText) - (discount)).toFixed(3);
                        subtotal.innerText = (parseFloat(subtotal.innerText) - (discount)).toFixed(3);
                    }

                }

            });

        function searchName() {

            var name = $('#product_search_input_name').val()
            $.ajax({
                url:"{{ path('fetch_product_name') }}",
                type: "POST",
                dataType: "text",
                data:{
                    name:name,
                },
                success: function(data){
                    var obj = jQuery.parseJSON(data);
//                    console.log(obj.name);

                    if(obj.price !== "") {
                        var prodAmount = 1;
                        var cart = $('.cart-table');
                        var prodName = obj.name;
                        var prodPrice = parseFloat(obj.price);

                        var prodID = obj.id;
                        var prodTaxable = obj.tax.toString();

                        var prod_quantity = $(this).parent().parent().find("#product-quantity");
                        if (prod_quantity[0] !== undefined) {
                            prod_quantity[0].innerText = parseInt(prod_quantity[0].innerText) - prodAmount;
                        }

                        var total = document.querySelector('#total');
                        var subtotal = document.querySelector('#subtotal');
                        var tax = document.querySelector('#tax');


                        var cellVal = $(".cart-table tr td").filter(function () {
                            return $(this).text() === prodName;
                        });
                        if (cellVal.text() === "") {
                            if (prodAmount === 1) {
                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">1</td><td id="price">' + prodPrice + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            } else {

                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">' + prodAmount + '</td><td id="price">' + (prodPrice * prodAmount) + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            }

                        } else {
                            var quantity = parseInt(cellVal.parent().children()[1].innerText);
                            cellVal.parent().children()[1].innerText = quantity + prodAmount;

                            var price = parseFloat(cellVal.parent().children()[2].innerText);
                            cellVal.parent().children()[2].innerText = price + (prodPrice * prodAmount);
                        }

                        if(prodTaxable ==="1"){
                    var taxPerProduct = (prodPrice/1.16) * 0.16;
                    var taxAmt = (taxPerProduct.toFixed(3) * prodAmount);
                    var taxDisplay = parseFloat(tax.innerText) + parseFloat(taxAmt);
                    tax.innerText = parseFloat(taxDisplay).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount) - taxAmt ).toFixed(3);

                }else{
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount)).toFixed(3);
                }
       
                    }
                },
                error: function(error){
                    console.log("Error:");
                    console.log(error);
                }

            });

        }

        function searchSKU() {

            var sku = $('#product_search_input_sku').val()
            $.ajax({
                url:"{{ path('fetch_product_sku') }}",
                type: "POST",
                dataType: "text",
                data:{
                    sku:sku,
                },
                success: function(data){
                    var obj = jQuery.parseJSON(data);
//                    console.log(obj.name);

                    if(obj.price !== "") {
                        var prodAmount = 1;
                        var cart = $('.cart-table');
                        var prodName = obj.name;
                        var prodPrice = parseFloat(obj.price);

                        var prodID = obj.id;
                        var prodTaxable = obj.tax.toString();

                        var prod_quantity = $(this).parent().parent().find("#product-quantity");
                        if (prod_quantity[0] !== undefined) {
                            prod_quantity[0].innerText = parseInt(prod_quantity[0].innerText) - prodAmount;
                        }

                        var total = document.querySelector('#total');
                        var subtotal = document.querySelector('#subtotal');
                        var tax = document.querySelector('#tax');


                        var cellVal = $(".cart-table tr td").filter(function () {
                            return $(this).text() === prodName;
                        });
                        if (cellVal.text() === "") {
                            if (prodAmount === 1) {
                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">1</td><td id="price">' + prodPrice + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            } else {

                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">' + prodAmount + '</td><td id="price">' + (prodPrice * prodAmount) + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            }

                        } else {
                            var quantity = parseInt(cellVal.parent().children()[1].innerText);
                            cellVal.parent().children()[1].innerText = quantity + prodAmount;

                            var price = parseFloat(cellVal.parent().children()[2].innerText);
                            cellVal.parent().children()[2].innerText = price + (prodPrice * prodAmount);
                        }

                       if(prodTaxable ==="1"){
                    var taxPerProduct = (prodPrice/1.16) * 0.16;
                    var taxAmt = (taxPerProduct.toFixed(3) * prodAmount);
                    var taxDisplay = parseFloat(tax.innerText) + parseFloat(taxAmt);
                    tax.innerText = parseFloat(taxDisplay).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount) - taxAmt ).toFixed(3);

                }else{
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount)).toFixed(3);
                }
                       

                    }
                },
                error: function(error){
                    console.log("Error:");
                    console.log(error);
                }

            });

        }

        function search(product_id) {

            $.ajax({
                url:"{{ path('fetch_product') }}",
                type: "POST",
                dataType: "text",
                data:{
                    upc:product_id,
                },
                success: function(data){
                    var obj = jQuery.parseJSON(data);
                    console.log(obj.name);

                    if(obj.price !== "") {
                        var prodAmount = 1;
                        var cart = $('.cart-table');
                        var prodName = obj.name;
                        var prodPrice = parseFloat(obj.price);

                        var prodID = obj.id;
                        var prodTaxable = obj.tax.toString();

                        var prod_quantity = $(this).parent().parent().find("#product-quantity");
                        if (prod_quantity[0] !== undefined) {
                            prod_quantity[0].innerText = parseInt(prod_quantity[0].innerText) - prodAmount;
                        }

                        var total = document.querySelector('#total');
                        var subtotal = document.querySelector('#subtotal');
                        var tax = document.querySelector('#tax');


                        var cellVal = $(".cart-table tr td").filter(function () {
                            return $(this).text() === prodName;
                        });
                        if (cellVal.text() === "") {
                            if (prodAmount === 1) {
                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">1</td><td id="price">' + prodPrice + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            } else {

                                $(".cart-table").prepend('<tr id="' + prodID + '"><td >' + prodName + '</td><td id="quantity">' + prodAmount + '</td><td id="price">' + (prodPrice * prodAmount) + '</td><td><div class="btn-group"><button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</button><div class="dropdown-menu dropdown-menu-right"><button class="remove_product dropdown-item text-danger" type="button">Borrar</button><button class="remove_all dropdown-item text-warning" type="button">Borrar Todos</button><button class="discount_product_1 dropdown-item text-success" id="myBtn" type="button" data-toggle="modal" data-target="#myModal" type="button">Descuentos</button></div></div></td></tr>');

                            }

                        } else {
                            var quantity = parseInt(cellVal.parent().children()[1].innerText);
                            cellVal.parent().children()[1].innerText = quantity + prodAmount;

                            var price = parseInt(cellVal.parent().children()[2].innerText);
                            cellVal.parent().children()[2].innerText = price + (prodPrice * prodAmount);
                        }

                      if(prodTaxable ==="1"){
                    var taxPerProduct = (prodPrice/1.16) * 0.16;
                    var taxAmt = (taxPerProduct.toFixed(3) * prodAmount);
                    var taxDisplay = parseFloat(tax.innerText) + parseFloat(taxAmt);
                    tax.innerText = parseFloat(taxDisplay).toFixed(3);
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount) - taxAmt ).toFixed(3);

                }else{
                    total.innerText = (parseFloat(total.innerText) + (prodPrice * prodAmount)).toFixed(3);
                    subtotal.innerText = (parseFloat(subtotal.innerText) + (prodPrice * prodAmount)).toFixed(3);
                }
                      


                    }
                },
                error: function(error){
                    console.log("Error:");
                    console.log(error);
                }

            });

        }


        function deleteRow(r) {
            var i = r.parentNode.parentNode.rowIndex;
            document.getElementById(".cart").deleteRow(i);
        }

        function payment(button) {


            var row_count = $('#cart tr').length;
            var discount_count = $('#cart-discount tr').length;
            if(row_count >4){
                button.disabled = true;
                button.value = "submitting...."
                var product_ids = [];
                var quantities = [];
                var prices = [];
                var total,subtotal,tax;
                var saleID;
                var client_name;
                var client_code;

                client_name = $('#client_name').val();

                if($('#client_code').val() !== ''){
                client_code = $('#client_code').val();
                }

                total = $('#cart tr').find('#total').text();
                total = parseFloat(total).toFixed(2);
                subtotal = $('#cart tr').find('#subtotal').text();
                subtotal = parseFloat(subtotal).toFixed(2);
                tax = $('#cart tr').find('#tax').text();
                tax = parseFloat(tax).toFixed(2);
                $('#cart tr').each(function(index, tr) {

                    if(index>0) {
                        if(index < row_count-3) {
                            var row = $(tr).closest('tr');
                            var quantity = row.find('#quantity').text();
                            var price = row.find('#price').text();
                          //   console.log("Index: "+index +" Id: "+tr.id+" Quantity: " + quantity);
                            product_ids.push(tr.id);
                            quantities.push(quantity);
                            prices.push(price);
                        }
                    }

                });

                if(discount_count > 1){
                    var discount_product_ids = [];
                    var reasons = [];
                    var discounts = [];
                    var discount_ids = [];

                    $('#cart-discount tr').each(function(index, tr) {

                        if(index>1) {
                            if(index < row_count-1) {
                                var row = $(tr).closest('tr');
                                var reason = row.find('.discount_reason').parent();
                                var price = row.find('#price').text();
                                var discountId = row.children()[1].id;
                              //  console.log("Index: "+index +" Id: "+tr.id+" Reason: " + reason +" price: " + price);
                                discount_product_ids.push(tr.id);
                                discount_ids.push(discountId);

                              //  reasons.push(reason);
                             //   discounts.push(price);
                            }
                        }

                    });

                }
            
                $.ajax({
                    url:"{{ path('create_sale') }}",
                    type: "POST",
                    data:{
                        products:product_ids,
                        quantity:quantities,
                        total:total,
                        subtotal:subtotal,
                        tax:tax,
                        client:client_name,
                        price:prices,
                        productDiscountId:discount_product_ids,
                        discountId:discount_ids,
                        code:client_code

                    },
                    success:function (php_result) {
                        console.log(php_result);
                        saleID = php_result.toString();
                        window.location.replace(saleID+"/payment");

                    }

                });
            
                

            }


        }




    </script>


{% endblock %}

{% block javascript %}


{% endblock %}

 {% block pagejs %}
   <script src="../theme/assets/extra-libs/datatables.net/js/jquery.dataTables.min.js"></script>
    <script>$('#zero_config').DataTable();</script>
    {% endblock %}